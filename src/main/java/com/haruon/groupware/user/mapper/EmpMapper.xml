<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.haruon.groupware.user.mapper.EmpMapper">
	<!-- 사원 상세정보 -->
	<select id="findByEmpInfo" parameterType="Integer" resultType="com.haruon.groupware.user.dto.ResponseEmpInfo">
		select
			   e.emp_no empNo
			 , e.email
			 , e.dep_no deptNo
			 , (select dname
			   from dept
			   where dep_no = e.dep_no) dname
			 , e.ename
			 , (select descript
			   from common_code
			   where common_code = location) location
			 , e.ext_num extNum
			 , e.phone
			 , e.address
			 , e.post_code postCode
			 , e.gender
			 , e.birth
			 , e.join_date joinDate
			 , f.file_name fileName
			 , f.ext ext
			 , sf.file_name signfileName
			 , sf.ext signExt
		  from emp e
		  left join emp_file f
			   on e.emp_no = f.emp_no
		  left join sign_file sf
			   on e.emp_no = sf.emp_no
		 where e.emp_no = #{empNo}
	</select>

	<select id="findByEmp" parameterType="String" resultType="com.haruon.groupware.user.entity.EmpEntity" >
		SELECT
			 	e.emp_no empNo
			,	e.email email
			,	e.emp_pw empPw
			,	e.ename ename
			,	e.location location
			,	e.dep_no depNo
			,	d.dname dname
		FROM emp e
		INNER JOIN dept d
			ON e.dep_no = d.dep_no
		WHERE email = #{email}
	</select>

	<insert id="insertEmp" parameterType="com.haruon.groupware.user.dto.EmpDto" >
		INSERT INTO emp (
		ename
		,emp_pw
		,post_code
		,email
		,address
		,phone
		,dep_no
		,gender
		,birth
		)VALUES(
			#{ename},#{empPw}, #{postCode}, #{email}, #{address}, #{phone} ,#{depNo} ,#{gender} ,#{birth}
		)
	</insert>
	
	<update id="updateEmpPw" parameterType="com.haruon.groupware.user.dto.EmpDto">
    UPDATE emp
    SET emp_pw = #{empPw}
    WHERE emp_no = #{empNo} AND email = #{email};
	</update>
	
	
	<!-- EMP : 퇴사하지 않은 모든 사원의 사원번호를 가져오기 -->
	<select id="findAllEmp" resultType="com.haruon.groupware.user.entity.EmpEntity">
		SELECT emp_no empNo , dep_no depNo
			 , email	    , ename 
			 , location     , join_date
			 , total_leave  , used_leave
		  FROM emp 
		 WHERE leave_date IS NULL
	</select>
	
	<!-- EMP : 직원의 연가 수 업데이트(매년 + 사원 등록시)  -->
	<update id="updateLeaveByAnnualorJoin" parameterType="com.haruon.groupware.user.entity.EmpEntity">
		UPDATE emp
	   	   SET total_leave = #{totalLeave}, used_leave=0
	   	 WHERE emp_no = #{empNo}
	</update>
	
	<!-- EMP : 기중 부서장이 한명의 연가 수 업데이트 -->
	<update id="updateTotalLeaveByDivision" parameterType="com.haruon.groupware.user.entity.EmpEntity">
		UPDATE emp
	   	   SET total_leave = #{totalLeave}
	   	 WHERE emp_no = #{empNo}
	</update>
	
	<!-- EMP : 가장 최근에 등록한 사원 -->
	<select id="findNewEmp" resultType="com.haruon.groupware.user.entity.EmpEntity">
		SELECT emp_no empNo, join_date joinDate FROM emp WHERE emp_no = (SELECT MAX(emp_no) FROM emp)
	</select>
</mapper>