<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper	namespace="com.haruon.groupware.attendance.mapper.AttendanceMapper">
	<!-- 어제, 한 사원의 근태 기록 조회 -->
	<select id="findAttendance" parameterType="com.haruon.groupware.attendance.entity.Attendance" 
			resultType="com.haruon.groupware.attendance.entity.Attendance">
		SELECT emp_no empNo
			 , start_time startTime
			 , end_time endTime
		  FROM attendance 
		 WHERE emp_no=#{empNo} AND start_time LIKE CONCAT('%', #{startTime}, '%')
	</select>	
	<!-- 어제, 한 사원의 연차 기록과 출장 기록 조회 --> 
	<select id="findDaySchByEmpAndDay" parameterType="com.haruon.groupware.attendance.entity.Attendance" 
			resultType="Map">
		
		 SELECT s.sch_no schNo
		      , cc.descript schType
			  , s.start_time startTime
			  , s.end_time endTime
		   FROM schedules s
		  INNER JOIN schedule_attendance sa ON sa.sch_no = s.sch_no
		  INNER JOIN common_code cc ON s.kind = cc.common_code
		  WHERE sa.emp_no = #{empNo}
		 	AND s.start_time LIKE CONCAT('%', #{startTime},'%')
		    AND s.kind IN (SELECT common_code from common_code
							WHERE parent_code 
							   IN (SELECT common_code FROM common_code
								    WHERE descript = 'schedule_kind')
							  AND (descript = '연차' OR descript = '출장' OR descript = '반차'))
	</select>
	
	<!-- 근태 업데이트 : 스케쥴링 -->
	<update id="updateAttendance" parameterType="com.haruon.groupware.attendance.entity.Attendance">
		UPDATE attendance 
		<trim prefix="set" suffixOverrides=",">
			<if test = "endTime != null">
				end_time = #{endTime},
			</if>
			<if test = "state != null">
				state = (SELECT common_code FROM common_code 
					  	  WHERE descript = #{state}
					  	    AND parent_code = (SELECT common_code FROM common_code 
												WHERE descript='attendance_state')),
			</if>
		</trim>
		WHERE emp_no = #{empNo} AND start_time LIKE CONCAT('%', #{startTime}, '%') AND state is null
	</update>

	<!-- 근태 정보 생성 (스케쥴링)-->
	<insert id="insertAttendance" parameterType="com.haruon.groupware.attendance.entity.Attendance">
	    Insert into attendance(
	        emp_no, start_time
	        <if test="endTime != ''">
	            , end_time
	        </if>
	        <if test="state != ''">
	            , state
	        </if>
	    ) VALUES (
	        #{empNo}, #{startTime}
	        <if test="endTime != ''">
	            , #{endTime}
	        </if>
	        <if test="state != ''">
	            , (SELECT common_code from common_code
	                WHERE parent_code 
	                   IN (SELECT common_code FROM common_code
	                        WHERE descript = 'attendance_state')
	                  AND descript = #{state})
	        </if>
	    )
	</insert>
	
	<!-- 오늘 출/퇴근 시간 조회 -->
	<select id="findAttendanceByEmp" parameterType="int" resultType="com.haruon.groupware.attendance.dto.ResponseAttendance">
		SELECT emp_no empNo
			 , start_time attendanceStartTime
		 	 , IFNULL(end_time, -1) attendanceEndTime
		  FROM attendance 
		 WHERE emp_no=#{empNo}
		   AND start_time LIKE CONCAT('%',DATE_FORMAT(NOW(), '%Y-%m-%d'), '%');
	</select>
	
	
</mapper>